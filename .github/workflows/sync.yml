name: Sync Contributions

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      backfill:
        description: 'Backfill all contributions since account creation'
        type: boolean
        default: false
      start_date:
        description: 'Start date (YYYY-MM-DD), overrides backfill'
        type: string
      end_date:
        description: 'End date (YYYY-MM-DD), defaults to today'
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Sync contributions
        env:
          PERSONAL_GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          WORK_GITHUB_USERNAME: ${{ vars.WORK_GITHUB_USERNAME }}
          PERSONAL_GITHUB_USERNAME: ${{ vars.PERSONAL_GITHUB_USERNAME }}
          TARGET_REPO_NAME: ${{ vars.TARGET_REPO_NAME }}
        run: |
          if [[ "${{ inputs.backfill }}" == "true" ]]; then
            uv run copiar.py --yes --backfill
          elif [[ -n "${{ inputs.start_date }}" ]]; then
            uv run copiar.py --yes --start ${{ inputs.start_date }} \
              ${{ inputs.end_date && format('--end {0}', inputs.end_date) || '' }}
          else
            uv run copiar.py --yes \
              --start $(date -u -d "yesterday" +%Y-%m-%d) \
              --end $(date -u -d "yesterday" +%Y-%m-%d)
          fi
